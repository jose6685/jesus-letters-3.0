<template>
  <div class="share-page">
    <div class="share-container">
      <!-- é é¢æ¨™é¡Œ -->
      <div class="page-header">
        <h2>è½è½çœ‹è€¶ç©Œæœƒæ€éº¼èªª</h2>
        <p>ç„¡è«–æ˜¯å›°æ“¾ã€æ„Ÿæ©æˆ–ç–‘å• è¨˜éŒ„ä¸‹ä¾†ï¼Œä»–å¿…æˆç‚ºä½  è…³å‰çš„ç‡ˆ è·¯ä¸Šçš„å…‰ å¤œé–“çš„æ­Œ</p>
      </div>

      <!-- åˆ†äº«è¡¨å–® -->
      <form @submit.prevent="handleSubmit" class="share-form">
        <!-- æå•å…§å®¹å€å¡Š -->
        <div class="form-section">
          <h3 class="section-title">æå•å…§å®¹</h3>
          
          <div class="form-group">
            <label for="nickname">æš±ç¨± *</label>
            <input
              type="text"
              id="nickname"
              v-model="formData.nickname"
              placeholder="è«‹è¼¸å…¥ä½ çš„æš±ç¨±"
              required
              maxlength="20"
            />
          </div>



          <div class="form-group">
            <label for="religion">å®—æ•™ä¿¡ä»°</label>
            <select id="religion" v-model="formData.religion">
              <option value="">è«‹é¸æ“‡</option>
              <option value="åŸºç£å¾’">åŸºç£å¾’</option>
              <option value="å¤©ä¸»æ•™å¾’">å¤©ä¸»æ•™å¾’</option>
              <option value="çŒ¶å¤ªæ•™">çŒ¶å¤ªæ•™</option>
              <option value="ä½›æ•™">ä½›æ•™</option>
              <option value="é“æ•™">é“æ•™</option>
              <option value="ä¼Šæ–¯è˜­æ•™">ä¼Šæ–¯è˜­æ•™</option>
              <option value="å°åº¦æ•™">å°åº¦æ•™</option>
              <option value="ç¥é“æ•™">ç¥é“æ•™</option>
              <option value="æ‘©é–€æ•™">æ‘©é–€æ•™</option>
              <option value="çµ±ä¸€æ•™">çµ±ä¸€æ•™</option>
              <option value="ä¸€è²«é“">ä¸€è²«é“</option>
              <option value="ç„¡å›ºå®šä¿¡ä»°">ç„¡å›ºå®šä¿¡ä»°</option>
              <option value="éåŸºç£å¾’">éåŸºç£å¾’</option>
              <option value="å…¶ä»–å®—æ•™">å…¶ä»–å®—æ•™</option>
              <option value="ç„¡å®—æ•™ä¿¡ä»°">ç„¡å®—æ•™ä¿¡ä»°</option>
            </select>
          </div>
        </div>

        <!-- åˆ†äº«å…§å®¹å€å¡Š -->
        <div class="form-section">
          <h3 class="section-title">æˆ‘è¦æå•</h3>
          
          <div class="form-group">
            <label>ä¸»é¡Œ * (å¯è¤‡é¸)</label>
            <div class="checkbox-group">
              <div class="checkbox-item">
                <input type="checkbox" id="topic-work" value="å·¥ä½œ" v-model="formData.topics">
                <label for="topic-work">å·¥ä½œ</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="topic-love" value="æ„Ÿæƒ…" v-model="formData.topics">
                <label for="topic-love">æ„Ÿæƒ…</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="topic-health" value="å¥åº·" v-model="formData.topics">
                <label for="topic-health">å¥åº·</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="topic-family" value="å®¶åº­" v-model="formData.topics">
                <label for="topic-family">å®¶åº­</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="topic-wealth" value="è²¡å¯Œ" v-model="formData.topics">
                <label for="topic-wealth">è²¡å¯Œ</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="topic-faith" value="ä¿¡ä»°" v-model="formData.topics">
                <label for="topic-faith">ä¿¡ä»°</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="topic-other" value="å…¶ä»–" v-model="formData.topics">
                <label for="topic-other">å…¶ä»–</label>
              </div>
            </div>
          </div>

          <div class="form-group">
            <label for="situation">å…·é«”æƒ…æ³(æ¦‚è¿°èˆ‡äº‹ä»¶é—œéµè©äº¦å¯) *</label>
            <textarea
              id="situation"
              v-model="formData.situation"
              placeholder="è«‹è©³ç´°æè¿°ä½ æƒ³åˆ†äº«çš„æƒ…æ³ã€å›°æ“¾æˆ–æ„Ÿæ©..."
              required
              rows="8"
              maxlength="2000"
            ></textarea>
            <div class="char-count">
              {{ formData.situation.length }}/2000
            </div>
          </div>
        </div>

        <!-- æäº¤æŒ‰éˆ• -->
        <div class="form-actions">
          <button type="button" class="btn-secondary" @click="handleBack">
            å–æ¶ˆ
          </button>
          <button 
            type="submit" 
            class="btn-primary"
            :disabled="isSubmitting || !isFormValid"
          >
            <span v-if="isSubmitting" class="loading-spinner"></span>
            {{ isSubmitting ? 'ç™¼é€ä¸­...' : 'èª å¿ƒåœ°ç™¼é€' }}
          </button>
        </div>
      </form>

      <!-- éš±ç§æç¤º -->
      <div class="privacy-notice">
        <div class="notice-icon">ğŸ”’</div>
        <div class="notice-content">
          <h4>éš±ç§ä¿è­·</h4>
          <p>ä½ çš„åˆ†äº«å…§å®¹å°‡è¢«å®‰å…¨è™•ç†ï¼Œæˆ‘å€‘é‡è¦–ä¸¦ä¿è­·ä½ çš„éš±ç§ã€‚</p>
        </div>
      </div>
    </div>
  </div>
</template>

<script>
import { ref, computed } from 'vue'
import { API_CONFIG } from '../config/api.js'

export default {
  name: 'SharePage',
  emits: ['letter-sent', 'back'],
  setup(props, { emit }) {
    const isSubmitting = ref(false)
    
    const formData = ref({
      nickname: '',
      religion: '',
      topics: [],
      situation: ''
    })

    // è¡¨å–®é©—è­‰
    const isFormValid = computed(() => {
      return formData.value.nickname.trim() && 
             formData.value.topics.length > 0 && 
             formData.value.situation.trim().length >= 10
    })

    // è™•ç†è¡¨å–®æäº¤
    const handleSubmit = async () => {
      if (!isFormValid.value || isSubmitting.value) return

      isSubmitting.value = true
      let response = null // åœ¨å‡½æ•¸é–‹å§‹æ™‚è²æ˜ response è®Šé‡

      try {
        // æº–å‚™ç™¼é€æ•¸æ“š
        const requestData = {
          userInput: {
            nickname: formData.value.nickname,
            situation: formData.value.situation,
            topic: formData.value.topics.join(', '), // å°‡é™£åˆ—è½‰æ›ç‚ºå­—ç¬¦ä¸²
            religion: formData.value.religion
          }
        }

        // ç™¼é€åˆ°å¾Œç«¯API
        response = await fetch(`${API_CONFIG.BASE_URL}${API_CONFIG.ENDPOINTS.AI_GENERATE}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(requestData)
        })

        // æª¢æŸ¥ HTTP ç‹€æ…‹ç¢¼
        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}))
          throw new Error(`HTTPéŒ¯èª¤ ${response.status}: ${errorData.error || 'ç«¯é»ä¸å­˜åœ¨'}`)
        }

        const result = await response.json()

        // æ ¹æ“šæœ‹å‹å»ºè­°ï¼šæª¢æŸ¥æ˜¯å¦æœ‰ error æ¬„ä½
        if (result.error) {
          throw new Error(`å¾Œç«¯éŒ¯èª¤ï¼š${result.error}`)
        }

        // æª¢æŸ¥æ•¸æ“šçµæ§‹æ˜¯å¦æ­£ç¢º
        if (!result.aiResponse) {
          throw new Error('AI å›æ‡‰æ ¼å¼ä¸æ­£ç¢º')
        }

        // å¾æ­£ç¢ºçš„æ•¸æ“šçµæ§‹ä¸­æå–AIéŸ¿æ‡‰
        const aiResponse = result.aiResponse

        // é©—è­‰å¿…è¦æ¬„ä½
        if (!aiResponse.jesusLetter || !aiResponse.guidedPrayer) {
          throw new Error('AI å›æ‡‰å…§å®¹ä¸å®Œæ•´')
        }

        // å‰µå»ºä¿¡ä»¶å°è±¡
        const letterData = {
          id: generateId(),
          nickname: requestData.userInput.nickname,
          topic: requestData.userInput.topic,
          situation: requestData.userInput.situation,
          jesusLetter: aiResponse.jesusLetter,
          guidedPrayer: aiResponse.guidedPrayer,
          biblicalReferences: processBiblicalReferences(aiResponse.biblicalReferences),
          coreMessage: aiResponse.coreMessage || '',
          createdAt: new Date().toISOString()
        }

        // ç™¼é€æˆåŠŸäº‹ä»¶
        emit('letter-sent', letterData)

        // é‡ç½®è¡¨å–®
        resetForm()

      } catch (error) {
        console.error('ç™¼é€ä¿¡ä»¶å¤±æ•—:', error)
        
        // æ ¹æ“šæœ‹å‹å»ºè­°ï¼šä¸‰ç¨®ç‹€æ³è™•ç†
        if (response && !response.ok) {
          // ç‹€æ³1ï¼šres.ok === false â†’ é¡¯ç¤º HTTP éŒ¯èª¤
          alert(`ç™¼é€ä¿¡ä»¶å¤±æ•—: Error: ${error.message}`)
        } else if (error.message.includes('å¾Œç«¯éŒ¯èª¤')) {
          // ç‹€æ³2ï¼šdata.error å­˜åœ¨ â†’ é¡¯ç¤º AI éŒ¯èª¤
          alert(`AI éŒ¯èª¤ï¼š${error.message}`)
        } else {
          // ç‹€æ³3ï¼šå…¶é¤˜ â†’ æ­£å¸¸é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
          if (error.name === 'TypeError' && error.message.includes('fetch')) {
            alert('ç¶²è·¯é€£æ¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯å¾Œé‡è©¦')
          } else if (error.message.includes('JSON')) {
            alert('ä¼ºæœå™¨å›æ‡‰æ ¼å¼éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦')
          } else {
            alert(`ç™¼é€ä¿¡ä»¶å¤±æ•—: Error: ${error.message}`)
          }
        }
      } finally {
        isSubmitting.value = false
      }
    }

    // è™•ç†è–ç¶“ç¶“æ–‡å¼•ç”¨ - å¢å¼·ç‰ˆæœ¬ï¼Œæ”¯æ´ä¸²æµå’Œä¸å®Œæ•´ JSON
    const processBiblicalReferences = (references) => {
      if (!references) return []
      
      // å¦‚æœå·²ç¶“æ˜¯æ•¸çµ„ï¼Œè™•ç†æ•¸çµ„ä¸­çš„æ¯å€‹å…ƒç´ 
      if (Array.isArray(references)) {
        return references.map(ref => {
          // å¦‚æœæ˜¯ç‰©ä»¶æ ¼å¼ { verse: "...", content: "..." }
          if (typeof ref === 'object' && ref !== null) {
            if (ref.verse && ref.content) {
              return `${ref.verse} - ${ref.content}`
            }
            // è™•ç†åªæœ‰éƒ¨åˆ†æ¬„ä½çš„ç‰©ä»¶
            if (ref.verse) return ref.verse
            if (ref.content) return ref.content
            // å¦‚æœæ˜¯å…¶ä»–ç‰©ä»¶æ ¼å¼ï¼Œå˜—è©¦è½‰æ›ç‚ºå­—ä¸²
            return JSON.stringify(ref)
          }
          // å¦‚æœæ˜¯å­—ç¬¦ä¸²ï¼Œé€²ä¸€æ­¥è™•ç†å¯èƒ½çš„ JSON æ ¼å¼
          if (typeof ref === 'string') {
            const parsed = parseStringReference(ref)
            // parseStringReference å¯èƒ½è¿”å›æ•¸çµ„ï¼Œéœ€è¦å±•é–‹
            if (Array.isArray(parsed)) {
              return parsed
            }
            return parsed
          }
          return String(ref)
        }).flat().filter(ref => ref && typeof ref === 'string' && ref.trim().length > 0)
      }
      
      // å¦‚æœæ˜¯å­—ç¬¦ä¸²ï¼Œå˜—è©¦è§£æ
      if (typeof references === 'string') {
        return parseStringReference(references)
      }
      
      // å¦‚æœæ˜¯å–®ä¸€ç‰©ä»¶
      if (typeof references === 'object' && references !== null) {
        if (references.verse && references.content) {
          return [`${references.verse} - ${references.content}`]
        }
        if (references.verse) return [references.verse]
        if (references.content) return [references.content]
      }
      
      return []
    }

    // è§£æå­—ç¬¦ä¸²æ ¼å¼çš„ç¶“æ–‡å¼•ç”¨
    const parseStringReference = (str) => {
      if (!str || typeof str !== 'string') return []
      
      // è™•ç†åŒ…å« JSON ç‰©ä»¶çš„å­—ç¬¦ä¸²
      if (str.includes('"verse":') || str.includes('"content":')) {
        const results = []
        
        // å˜—è©¦åŒ¹é…å®Œæ•´çš„ JSON ç‰©ä»¶
        const completeJsonMatches = str.match(/\{\s*"verse":\s*"[^"]*(?:\\.[^"]*)*",\s*"content":\s*"[^"]*(?:\\.[^"]*)*"\s*\}/g)
        if (completeJsonMatches) {
          completeJsonMatches.forEach(match => {
            try {
              const obj = JSON.parse(match)
              if (obj.verse && obj.content) {
                results.push(`${obj.verse} - ${obj.content}`)
              } else if (obj.verse) {
                results.push(obj.verse)
              } else if (obj.content) {
                results.push(obj.content)
              }
            } catch (e) {
              console.warn('è§£æå®Œæ•´ JSON ç‰©ä»¶å¤±æ•—:', e, match)
              results.push(match) // ä¿ç•™åŸå§‹å­—ä¸²
            }
          })
        }
        
        // è™•ç†ä¸å®Œæ•´çš„ JSON ç‰‡æ®µ
        if (results.length === 0) {
          // å˜—è©¦æå– verse å’Œ content æ¬„ä½
          const verseMatch = str.match(/"verse":\s*"([^"]*(?:\\.[^"]*)*)"/g)
          const contentMatch = str.match(/"content":\s*"([^"]*(?:\\.[^"]*)*)"/g)
          
          if (verseMatch && contentMatch) {
            const verses = verseMatch.map(m => m.match(/"verse":\s*"([^"]*)"/)?.[1]).filter(Boolean)
            const contents = contentMatch.map(m => m.match(/"content":\s*"([^"]*)"/)?.[1]).filter(Boolean)
            
            // é…å° verse å’Œ content
            for (let i = 0; i < Math.max(verses.length, contents.length); i++) {
              const verse = verses[i] || ''
              const content = contents[i] || ''
              if (verse && content) {
                results.push(`${verse} - ${content}`)
              } else if (verse) {
                results.push(verse)
              } else if (content) {
                results.push(content)
              }
            }
          } else if (verseMatch) {
            verseMatch.forEach(m => {
              const verse = m.match(/"verse":\s*"([^"]*)"/)?.[1]
              if (verse) results.push(verse)
            })
          } else if (contentMatch) {
            contentMatch.forEach(m => {
              const content = m.match(/"content":\s*"([^"]*)"/)?.[1]
              if (content) results.push(content)
            })
          }
        }
        
        if (results.length > 0) return results
      }
      
      // å˜—è©¦æ¨™æº– JSON è§£æ
      try {
        const parsed = JSON.parse(str)
        if (Array.isArray(parsed)) {
          return processBiblicalReferences(parsed) // éæ­¸è™•ç†
        }
        if (typeof parsed === 'object' && parsed !== null) {
          return processBiblicalReferences(parsed)
        }
      } catch (e) {
        // JSON è§£æå¤±æ•—ï¼Œä½¿ç”¨æ›è¡Œç¬¦åˆ†å‰²
        return str
          .split('\n')
          .map(ref => ref.trim())
          .filter(ref => ref.length > 0 && !ref.match(/^[\{\}",:\s]*$/)) // éæ¿¾æ‰åªåŒ…å« JSON ç¬¦è™Ÿçš„è¡Œ
      }
      
      return [str.trim()].filter(ref => ref && ref.length > 0)
    }

    // ç”Ÿæˆå”¯ä¸€ID
    const generateId = () => {
      return Date.now().toString(36) + Math.random().toString(36).substr(2)
    }

    // é‡ç½®è¡¨å–®
    const resetForm = () => {
      formData.value = {
        nickname: '',
        religion: '',
        topics: [],
        situation: ''
      }
    }

    // è¿”å›ä¸Šä¸€é 
    const handleBack = () => {
      emit('back')
    }

    return {
      formData,
      isSubmitting,
      isFormValid,
      handleSubmit,
      handleBack,
      processBiblicalReferences
    }
  }
}
</script>

<style scoped>
.share-page {
  min-height: 100vh;
  background: var(--bg-secondary);
  padding: 1rem;
}

.share-container {
  max-width: 600px;
  margin: 0 auto;
  padding-bottom: 2rem;
}

.page-header {
  text-align: center;
  margin-bottom: 2rem;
  padding: 2rem 1rem;
  background: linear-gradient(135deg, var(--primary-color), #357ABD);
  color: white;
  border-radius: var(--border-radius-lg);
  box-shadow: var(--shadow-medium);
}

.page-header h2 {
  font-size: 1.5rem;
  font-weight: 600;
  margin-bottom: 0.5rem;
}

.page-header p {
  opacity: 0.9;
  font-size: 1rem;
}

.share-form {
  background: var(--bg-primary);
  border-radius: var(--border-radius-lg);
  padding: 2rem;
  box-shadow: var(--shadow-light);
  border: 1px solid var(--border-color);
}

.form-section {
  margin-bottom: 2rem;
}

.form-section:last-child {
  margin-bottom: 0;
}

.section-title {
  font-size: 1.2rem;
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 1.5rem;
  padding-bottom: 0.5rem;
  border-bottom: 2px solid var(--primary-color);
}

.form-group {
  margin-bottom: 1.5rem;
}

.form-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1rem;
}

label {
  display: block;
  font-weight: 500;
  color: var(--text-primary);
  margin-bottom: 0.5rem;
}

input,
select,
textarea {
  width: 100%;
  padding: 0.75rem;
  border: 2px solid var(--border-color);
  border-radius: var(--border-radius);
  font-size: 1rem;
  font-family: inherit;
  background: var(--bg-primary);
  color: var(--text-primary);
  transition: var(--transition);
}

input:focus,
select:focus,
textarea:focus {
  outline: none;
  border-color: var(--primary-color);
  box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
}

textarea {
  resize: vertical;
  min-height: 120px;
  line-height: 1.5;
}

.char-count {
  text-align: right;
  font-size: 0.85rem;
  color: var(--text-muted);
  margin-top: 0.5rem;
}

/* è¤‡é¸æ¡†æ¨£å¼ */
.checkbox-group {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
  gap: 0.75rem;
  margin-top: 0.5rem;
}

.checkbox-item {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.checkbox-item input[type="checkbox"] {
  width: auto;
  margin: 0;
  cursor: pointer;
}

.checkbox-item label {
  margin: 0;
  cursor: pointer;
  font-weight: normal;
  color: var(--text-secondary);
  transition: var(--transition);
}

.checkbox-item input[type="checkbox"]:checked + label {
  color: var(--primary-color);
  font-weight: 500;
}

.form-actions {
  display: flex;
  gap: 1rem;
  justify-content: flex-end;
  margin-top: 2rem;
  padding-top: 2rem;
  border-top: 1px solid var(--border-color);
}

.btn-primary,
.btn-secondary {
  padding: 0.75rem 2rem;
  border-radius: 50px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: var(--transition);
  border: none;
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
}

.btn-primary {
  background: var(--primary-color);
  color: white;
}

.btn-primary:hover:not(:disabled) {
  background: #357ABD;
  transform: translateY(-2px);
}

.btn-primary:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

.btn-secondary {
  background: var(--bg-tertiary);
  color: var(--text-secondary);
  border: 1px solid var(--border-color);
}

.btn-secondary:hover {
  background: var(--border-color);
}

.loading-spinner {
  width: 16px;
  height: 16px;
  border: 2px solid rgba(255,255,255,0.3);
  border-top: 2px solid white;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.privacy-notice {
  display: flex;
  align-items: flex-start;
  gap: 1rem;
  background: rgba(126, 211, 33, 0.1);
  border: 1px solid rgba(126, 211, 33, 0.3);
  border-radius: var(--border-radius);
  padding: 1rem;
  margin-top: 1.5rem;
}

.notice-icon {
  font-size: 1.5rem;
  flex-shrink: 0;
}

.notice-content h4 {
  font-size: 1rem;
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 0.25rem;
}

.notice-content p {
  font-size: 0.9rem;
  color: var(--text-secondary);
  line-height: 1.4;
}

/* éŸ¿æ‡‰å¼è¨­è¨ˆ */
@media (max-width: 768px) {
  .share-page {
    padding: 0.5rem;
  }
  
  .share-form {
    padding: 1.5rem;
  }
  
  .form-row {
    grid-template-columns: 1fr;
  }
  
  .form-actions {
    flex-direction: column-reverse;
  }
  
  .btn-primary,
  .btn-secondary {
    width: 100%;
    justify-content: center;
  }
}

@media (max-width: 480px) {
  .page-header {
    padding: 1.5rem 1rem;
  }
  
  .page-header h2 {
    font-size: 1.3rem;
  }
  
  .share-form {
    padding: 1rem;
  }
  
  .section-title {
    font-size: 1.1rem;
  }
}
</style>